# 对象存储文件迁移

# 一、场景

有些项目在一开始没有定义好存储桶并且存储都是存到/目录下，导致后期发现存储的文件对应不上客户的桶，而且/目录下的文件特别的多的情况无法直接整个桶复制到另外一个存储桶，需要过滤出项目中存储错的部分图片进行迁移。

# 二、步骤

1.  连接数据库，在数据库中找出所有的图片地址
    
2.  将图片下载到本地（我使用的wget的方式）
    
3.  上传以上图片到正确的存储桶下
    
4.  修改数据库中的图片地址
    

# 三、迁移

## 1、找出数据库中的图片地址

1.  进入数据库模式public，右键public选择在模式中查找
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jWgZOZezwZeQqLX8/img/94bbb82d-4bfc-4d71-a673-e8dc2d41e0b3.png)

2.  输入需要迁移的图片的地址
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jWgZOZezwZeQqLX8/img/3008718e-315b-49d9-b9b5-920c88438fa9.png)

右边显示的就是涉及这些图片的表，需要一个一个进入表中复制出这些地址

3.  复制图片地址
    

双击进入以上所有的表，然后复制整列图片地址并存到一个文件里

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jWgZOZezwZeQqLX8/img/45d288be-1374-40b5-91a6-ddffee793121.png)

将地址复制到image.txt文件下

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jWgZOZezwZeQqLX8/img/e6d7f526-ab89-439d-833d-97fa2da743fa.png)

## 2、去重

因为有些图片过滤出来可能是重复的，所以最好对图片进行去重的操作，我使用的是Emeditor这个软件：

1.  全选文件
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jWgZOZezwZeQqLX8/img/2bb25305-d1b8-4303-8f87-f8cb109a3e83.png)

2.  右键 -> 高级 -> 删除重复行
    

## 3、下载图片

把整理好的图片连接下载下来，下载方式使用到wget的工具，找一台linux机器进行下载

1.  下载前需要对image.txt的文件转换格式(从windosw上到linux)
    

安装dos2unix

    # yum -y install dos2unix
    # dos2unix image.txt
    dos2unix: converting file image.txt to Unix format ...

2.  wget下image.txt下的图片
    

    # mkdir /root/image
    # for i in `cat image.txt`;do wget $i -P /root/image;done
    # tar -czf image.tar.gz image
    # sz image.tar.gz

3.  将下载下来的图片通过对象存储的工具进行上传
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jWgZOZezwZeQqLX8/img/c0035523-6935-4fa7-9c93-a7b843567eea.png)

4.  验证其中的资源是否可以访问
    

## 4、替换原数据库的地址

1.  将刚才在模式中过滤出来的数据导成一个update的sql
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jWgZOZezwZeQqLX8/img/3d7a9151-c4be-4b1a-8315-db617d7f8ec0.png)

右键 -> 复制为update语句

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jWgZOZezwZeQqLX8/img/4b5f97c6-e31f-4a32-8656-dd26600a5741.png)

将过滤出来的所有表复制为update域名并写道一个文件中

2.  将旧地址替换为新的地址，例如：
    

旧地址：[https://shushangyun01.oss-cn-shenzhen.aliyuncs.com/会员变更申请单全流程d46aaccf31ef406692eeb72bb3db41c2.png](https://shushangyun01.oss-cn-shenzhen.aliyuncs.com/会员变更申请单全流程d46aaccf31ef406692eeb72bb3db41c2.png)

新地址：[https://zjtx.obs.cn-gdgz1.ctyun.cn/images/会员变更申请单全流程d46aaccf31ef406692eeb72bb3db41c2.png](https://zjtx.obs.cn-gdgz1.ctyun.cn/images/会员变更申请单全流程d46aaccf31ef406692eeb72bb3db41c2.png)

需要将SQL文件中的[https://shushangyun01.oss-cn-shenzhen.aliyuncs.com](https://shushangyun01.oss-cn-shenzhen.aliyuncs.com/会员变更申请单全流程d46aaccf31ef406692eeb72bb3db41c2.png)替换为[https://zjtx.obs.cn-gdgz1.ctyun.cn/images](https://zjtx.obs.cn-gdgz1.ctyun.cn/images/会员变更申请单全流程d46aaccf31ef406692eeb72bb3db41c2.png)

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/jWgZOZezwZeQqLX8/img/24b97061-94eb-444b-ab97-a3236d71f946.png)

3.  执行update语句
    

1.  验证系统是否还有旧的地址