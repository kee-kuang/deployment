#                              梦金园部署文档

## 一、 服务器配置

  

```
    useradd www
```



## 二、部署JDK 

   应用服务器上部署 

    tar -xf jdk1.8.0_241.tar.gz -C /usr/local/
    vim /etc/profile
    ##java config
    #export JAVA_HOME=/usr/local/jdk1.8.0_241
    #export JRE_HOME=${JAVA_HOME}/jre
    #export CLASSPATH=.:${JAVA_HOME}/lib:${JRE_HOME}/lib
    #export PATH=${JAVA_HOME}/bin:$PATH‘
    source /etc/profile
    java --version

## 三、部署LibreOffice

  应用服务器部署

    yum -y install ibus > /dev/null
    tar -xf LibreOffice_6.4.6_Linux_x86-64_rpm.tar.gz
    yum -y localinstall LibreOffice_6.4.6.2_Linux_x86-64_rpm/RPMS/*.rpm
    echo "export LibreOffice_PATH=/opt/libreoffice6.4/program" >> /etc/profile
    echo "export PATH=$LibreOffice_PATH:$PATH" >> /etc/profile
    source /etc/profile
    tar -xf truetype.tar.gz
    rm -rf /opt/libreoffice6.4/share/fonts/truetype
    mv truetype /opt/libreoffice6.4/share/fonts/

## 四、部署Nodejs 

     应用服务器部署

    tar -xf node-v16.5.0-linux-x64.tar.gz -C /usr/local
    ln -s /usr/local/node-v16.5.0-linux-x64/ /usr/local/nodejs
    echo "export PATH=$PATH:/usr/local/nodejs/bin" >> /etc/profile
    source /etc/profile
    node -v
    npm -v
    #安装pm2
    npm install pm2 -g  >> /dev/null
    pm2 -v
    pm2 startup
    pm2 list
    #安装yarn
    npm install yarn -g  >> /dev/null
    yarn -v

## 五、创建后端服务

    mkdir /data/logs 
    mkdir /data/mengjinyuan/{后端服务名称}
    mkdir /data/mall/
    vim /data/mengjinyuan/.config
    # 填写Nacos 相关的 地址 端口 命名空间
    #export LINGXI_NACOS_ADDR=10.0.105.21
    #export LINGXI_NACOS_PORT=8848
    #export LINGXI_NACOS_NAMESPACE=server
    #export LINGXI_NACOS_GROUP=v1.0.0


## 六、部署Nginx

    yum install -y gcc pcre pcre-devel openssl-devel libxml2-devel libxslt-devel gd-devel perl-devel perl-ExtUtils-Embed GeoIP-devel 
    tar -xf ./tengine/tengine-2.2.0.tar.gz -C ./tengine
    cd ./tengine/tengine-2.2.0
    ./configure --enable-mods-static=all --prefix=/usr/local/nginx --with-ipv6 
    mkdir /usr/local/nginx/conf/conf.d
    cp ../nginx.conf /usr/local/nginx/conf/nginx.conf
    cp ../nginx /etc/init.d/nginx
    chmod +x /etc/init.d/nginx
    chkconfig --add nginx
    chkconfig nginx on
    service nginx start

## 七、部署Postgresql 

    yum install -y readline readline-devel openssl openssl-devel zlib zlib-devel
    yum -y install https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm
    yum -y install postgresql12 postgresql12-server 
    mkdir -p /data/postgresql/data
    chown -R postgres.postgres /data/postgresql
    su postgres -c "/usr/pgsql-12/bin/initdb -D /data/postgresql/data/" 
    sed -i "s/#listen_addresses = 'localhost'/listen_addresses = '*'/g" /data/postgresql/data/postgresql.conf
    sed -i "s/max_connections = 100/max_connections = 500/g" /data/postgresql/data/postgresql.conf
    echo "host    all             all             0.0.0.0/0               md5" >> /data/postgresql/data/pg_hba.conf
    sed -i 's#PGDATA=/var/lib/pgsql/12/data/#PGDATA=/data/postgresql/data/#g' /usr/lib/systemd/system/postgresql-12.service
    systemctl daemon-reload
    systemctl enable postgresql-12
    systemctl start postgresql-12
    su posgres & psql
    alter user postgres encrypted password 'password';
    create user 用户名 with password '密码';
    create database 数据库名 owner 用户名;
    grant all privileges on database 数据库名 to 用户名;

## 八、部署Docker& Docker-compose 

    yum install -y yum-utils device-mapper-persistent-data lvm2 
    yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 
    yum -y install docker-ce 
    systemctl start docker
    cp ./docker/docker-compose /usr/local/bin/
    chmod +x /usr/local/bin/docker-compose
    docker-compose -v 

## 九、部署中间件服务（rabbitmq es kibana redis arthas zipkin）

1.  创建相关映射目录和相关配置文件
    
    ```shell
    mkdir -p /data/{es,rabbitmq,redis,nacos}
    mkdir -p /data/es/conf
    chmod -R 775 /data/es
    chown -R www. /data/es
    cp redis.conf /data/redis/
    cp elasticsearch.yml /data/es/conf
    ```
    
    vim redis.conf
    
    ```
    daemonize no
    pidfile /var/run/redis.pid
    port 6379
    bind 0.0.0.0
    timeout 
    loglevel verbose
    logfile /data/redis.log
    databases 16
    save 900 1
    save 300 10
    save 60 10000
    rdbcompression yes
    dbfilename dump.rdb
    dir ./
    requirepass mengjinyuan
    appendonly yes
    appendfsync everysec
    no-appendfsync-on-rewrite no
    auto-aof-rewrite-percentage 100
    auto-aof-rewrite-min-size 64mb
    slowlog-log-slower-than 10000
    slowlog-max-len 1024
    list-max-ziplist-entries 512
    list-max-ziplist-value 64
    set-max-intset-entries 512
    zset-max-ziplist-entries 128
    zset-max-ziplist-value 64
    activerehashing yes
    ```
    
    vim elasticsearch.yml
    
    ```yaml
    cluster.name: "es"
    network.host: 0.0.0.0
    http.port: 9200
    
    http.cors.enabled: true
    http.cors.allow-origin: "*"
    http.cors.allow-headers: Authorization
    
    xpack.security.enabled: true
    xpack.security.transport.ssl.enabled: true
    ```
    
    vim docker-compose.yml
    
    ```yaml
    services:
      zipkin:
        image: registry.cn-guangzhou.aliyuncs.com/jdkj/zipkin:latest 
        container_name: zipkin
        ports:
    
       - 9411:9411
         start: always
    
      redis:
        image: registry.cn-guangzhou.aliyuncs.com/jdkj/redis:6.0.10
        container_name: redis
        ports:
          - 6379:6379
        restart: always
        volumes:
          - /data/redis/redis.conf:/etc/redis.conf
          - /data/redis/data:/data
        command: redis-server /etc/redis.conf
    
    
      rabbitmq:
        image: registry.cn-guangzhou.aliyuncs.com/jdkj/rabbitmq:rabbitmq-delayed-3.8.9 
        container_name: rabbitmq
        ports:
          - 5672:5672
          - 15672:15672
        restart: always
        environment:
          - "RABBITMQ_DEFAULT_USER=root"
          - "RABBITMQ_DEFAULT_PASS=mengjinyuan"
        volumes:
          - /data/rabbitmq/data:/var/lib/rabbitmq
          - /data/rabbitmq/logs:/var/log/rabbitmq/log
    
      nacos:
        image: registry.cn-guangzhou.aliyuncs.com/jdkj/nacos:v2.1.0
        container_name: nacos
        ports:
          - 8848:8848
          - 9848:9848
        environment:
          - "MODE=standalone"
        volumes:
          - /data/nacos/data:/home/nacos/data
          - /data/nacos/logs:/home/nacos/logs
        restart: always 
        
      elasticsearch:
        image: registry.cn-guangzhou.aliyuncs.com/jdkj/elasticsearch:7.10.1
        container_name: es
        ports:
          - 9200:9200
          - 9300:9300
        environment:
          - "discovery.type=single-node"
          - "ES_JAVA_OPTS=-Xms512m -Xmx1024m"
          - "ELASTIC_PASSWORD=mengjinyuan"
          - "TAKE_FILE_OWNERSHIP=true"
        volumes:
          - /data/es/data:/usr/share/elasticsearch/data:rw
          - /data/es/logs:/usr/share/elasticsearch/logs:rw
          - /data/es/conf/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
        restart: always
    
    
      kibana:
        image: registry.cn-guangzhou.aliyuncs.com/jdkj/kibana:7.10.1
        container_name: kibana
        ports:
          - 5601:5601
        links:
          - "elasticsearch:elasticsearch"
        environment:
          - "ELASTICSEARCH_HOSTS=http://elasticsearch:9200"
          - "ELASTICSEARCH_USERNAME=elastic"
          - "ELASTICSEARCH_PASSWORD=mengjinyuan"
        restart: always
    
      arthas: 
        image: registry.cn-guangzhou.aliyuncs.com/keetest/arthas:v1
        container_name: arthas
        ports:
          - 8080:8080
          - 7777:7777
        restart: always
    ```
    
    
    
2.  使用docker-compose 启动中间件
    
    ```shell
    mv docker-compose.yml /data/basic
    cd /data/basic
    docker-compose up -d 
    docker ps 
    ```
    
    
    

## 十、导入Nacos配置

导入Nacos 配置并根据实际配置修改common.yml对应的参数