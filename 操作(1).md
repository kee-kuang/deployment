# 操作

### 卷创建(已执行)

```
pvcreate /dev/sdb
vgcreate vg /dev/sdb
lvcreate -n lv -L 799G vg
mkfs.ext4 /dev/vg/lv
mkdir /data
mount /dev/vg/lv /data
echo '/dev/vg/lv /data ext4 defaults 0 0' | sudo tee -a /etc/fstab
104:
mount 172.20.5.44:/data /home/docker-3
```

### 迁移前新集群验证

```
44:
vim /etc/hosts
172.20.5.44 ma-act.i-liaoning.com.cn
curl https://ma-image.i-liaoning.com.cn/media/image/2020/12/18/lC41BR75Jb.png
curl https://ma-act.i-liaoning.com.cn/apidomain/activities/666
```



### 打包代码(已上传到网盘)

```
需要修改代码内容：
mysql: 172.20.5.44:3306
mq:172.20.5.45:9876
zk: 172.20.5.45:2181
```



### 暂停旧服务

```
docker service scale nginx_nginx=0

5分钟后...

docker service scale app_wap-h5=0
docker service scale app_wap-api=0
docker service scale app_web_api=0
docker service scale app_web-h5=0

```



### Mysql 数据迁移

```
1. 数据 105迁移到 44/data
# 44创建一个共享目录(已执行)
44:
systemctl start nfs-server
vim /etc/exports
  /data 172.20.5.44(rw,sync)
exportfs -rv
#复制数据
104:
nohup cp -r /data/mysql /home/docker-3

44:
watch /data/mysql 

#执行启动命令：
cd /home/docker-1/qianyi-k
docker node ls
docker node update --label-add mysql=true 8j1vaoiz18mdg6uf605jizfeg (已执行)

docker stack deploy -c mysql2-k.yml

代码修改地址：
mysql 172.20.5.44:3306

验证：
select * from shushangyun.sub_1_1304_landing_page_logs where  customer_id = 1752024 and `type` = 7;

select * from activity_draft where activity_id = 29;
```

### 新集群启动之后 

```
44:
vim /etc/hosts
172.20.5.44 ma-act.i-liaoning.com.cn
curl https://ma-image.i-liaoning.com.cn/media/image/2020/12/18/lC41BR75Jb.png
curl https://ma-act.i-liaoning.com.cn/apidomain/activities/666
curl https://ma-act.i-liaoning.com.cn/apidomain/landing-pages/1om5t7u73cxp
```



### nginx

```
旧集群：229 230 231 37
37：
docker stack rm nginx 
cd /home/docker-1/qianyi-k/
docker stack deploy -c nginx.yml
```



### B端和c端app访问是否正常



