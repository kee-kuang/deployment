# 系统崩溃及恢复步骤文档

# 一、K8S集群节点故障后如何检查和恢复

## 故障排查

1.  **确认节点问题：**
    

使用 kubectl get nodes 命令检查节点的状态。如果节点的状态为 "NotReady" 或其他异常状态，表明节点存在问题。

2.  **查看节点事件：**
    

运行 kubectl describe node <节点名称> 来查看节点的详细信息和事件。查看有关故障的更多信息，例如节点上的 Pod 何时无法调度等。

3.  **检查节点日志：**
    

检查节点本身的系统日志以查看是否有硬件或操作系统问题。可以查看 /var/log/messages 或 /var/log/syslog。

4.  **检查容器运行时问题：**
    

如果 Pod 中的容器无法正常启动或终止，可以查看容器日志以获取更多信息。使用 kubectl logs <Pod名称> -c <容器名称> 来查看容器的日志。

5.  **检查资源问题：**
    

如果节点上的资源不足，可能导致 Pod 无法调度或容器无法正常运行。使用 kubectl describe node <节点名称> 来查看节点的资源利用情况。

## 故障恢复

1.  **修复节点问题：**
    

如果问题是可以修复的，例如硬件故障或操作系统问题，尝试修复节点。这可能包括重启节点或解决硬件问题。

2.  **替换节点：**
    

如果节点无法修复，考虑替换节点。创建一个新的节点并将其添加到集群中，确保新节点与集群配置一致，并将旧节点上的Pod驱逐到新的节点上。

3.  **网络问题：**
    

如果节点存在网络问题，检查网络配置、防火墙规则等，确保节点能够正常通信。节点上的iptables以及腾讯云上的安全组，网络插件运行是否正常。

4.  **资源不足：**
    

如果资源不足，扩展节点的资源，如 CPU、内存或存储。可以调整 Pod 的请求和限制以更有效地利用资源。

5.  **节点丢失：**
    

如果节点永久丢失，从集群中删除它，以防止 K8s 尝试将 Pod 调度到不可用的节点。

# 二、容器故障后如何检查和恢复

## 故障排查

1.  **查看容器状态：**
    

使用 kubectl get pods 命令来检查 Pod 的状态。如果一个或多个容器在 Pod 中处于错误状态（例如 CrashLoopBackOff），表示Pod中发生了重启循环。

2.  **查看容器日志：**
    

使用 kubectl logs <Pod名称> -c <容器名称> 命令查看容器的日志，以获取关于容器故障的详细信息。容器的日志通常会提供关于错误消息、异常和问题的线索。

3.  **查看容器资源和配置：**
    

使用 kubectl describe pod <Pod名称> 命令查看 Pod 的详细信息，包括容器的资源请求、限制、环境变量和配置。确保容器的配置和资源分配是正确的。

4.  **检查健康检查：**
    

如果您在 Pod 中定义了健康检查，查看健康检查的状态。使用 kubectl describe pod <Pod名称> 来查看容器的健康检查结果。健康检查失败可能会导致容器被标记为不健康。

5.  **检查镜像是否能获取到：**
    

确保容器使用的映像存在并可以访问。使用 kubectl describe pod <Pod名称> 查看容器的映像定义。确认镜像仓库中的镜像是否已上传。

6.  **检查网络问题：**
    

1.  检查网路拓扑
    

确保 Kubernetes 集群中的网络拓扑是正确配置的，包括子网、路由、VPC等。检查节点和服务是否在正确的子网中。

2.  节点间通信
    

*   使用命令 kubectl get nodes 来检查集群中各个节点的状态。确保所有节点都是 "Ready" 状态。
    
*   使用 kubectl describe node <节点名称> 检查节点的详细信息，包括网络配置、IP 地址等。确保节点的网络配置正确。
    

1.  Pod间通信
    

*   使用 kubectl get pods -n <命名空间> 来检查 Pod 的状态。确保 Pod 处于正常运行状态。
    
*   使用 kubectl describe pod <Pod名称> -n <命名空间> 来查看 Pod 的详细信息，包括 IP 地址、容器信息、事件等。
    

1.  服务通信
    

*   使用 kubectl get services -n <命名空间> 来查看服务的状态。确保服务正常运行。
    
*   使用 kubectl describe service <服务名称> -n <命名空间> 来查看服务的详细信息，包括端口和 IP 地址。
    

## 故障恢复

1.  **容器崩溃：**
    

*   问题描述：容器中的应用程序由于代码错误或配置问题而崩溃，容器状态为 Terminated。
    
*   恢复方法：
    
    *   修复应用程序问题。
        
    *   构建新的容器映像，包含修复后的代码或配置。
        
    *   更新 Pod 的容器定义，使用新的容器映像。
        
    *   使用 kubectl delete pod <Pod名称> 删除故障的 Pod，K8s 将自动创建一个新的 Pod。
        

1.  **资源不足：**
    

*   问题描述：容器使用的资源（CPU、内存）超过了其请求或限制，导致容器终止。
    
*   恢复方法：
    
    *   调整 Pod 的资源请求和限制，确保它们适合容器的需求。
        
    *   更新 Pod 的资源定义，使用 kubectl edit pod <Pod名称> 或 kubectl apply -f <Pod配置文件>。
        
    *   使用 kubectl describe pod <Pod名称> 检查 Pod 的资源使用情况。
        

1.  **存储问题：**
    

*   问题描述：容器无法访问其依赖的存储卷，或存储卷数据损坏。
    
*   恢复方法：
    
    *   检查存储卷配置，确保存储卷正确挂载到容器中。
        
    *   如果数据损坏，还原数据或使用备份进行恢复。
        
    *   使用 kubectl describe pod <Pod名称> 查看存储卷挂载信息。
        

1.  **网络问题：**
    

*   问题描述：容器无法连接到外部服务，或容器之间无法通信。
    
*   恢复方法：
    
    *   检查网络配置，确保容器可以访问所需的网络资源。
        
    *   检查防火墙规则，网络策略或 DNS 配置。
        
    *   使用 ping、curl 或 nslookup 命令测试网络连接。
        

1.  **配置错误：**
    

*   问题描述：容器配置错误，导致应用程序无法启动。
    
*   恢复方法：
    
    *   检查容器的环境变量、配置文件和命令，确保它们正确设置。
        
    *   修复配置问题，然后重新部署容器。
        

1.  **容器映像问题：**
    

*   问题描述：容器使用的映像不存在或无法下载。
    
*   恢复方法：
    
    *   检查 Pod 的容器映像定义，确保映像存在并可以访问。
        
    *   修复映像问题，然后重新部署容器。
        

1.  **健康检查失败：**
    

*   问题描述：Kubernetes 中定义的健康检查失败，导致容器被标记为不健康。
    
*   恢复方法：
    
    *   检查健康检查定义，确保其条件设置正确。
        
    *   修复应用程序问题，以确保健康检查通过。
        

1.  **并发问题：**
    

*   问题描述：容器之间的竞争条件或并发问题，导致应用程序错误。
    
*   恢复方法：
    
    *   修复并发问题，更新容器代码，并重新部署容器。
        

# 三、服务器负载过高

## 现象描述

节点高负载将会导致进程无法获得足够运行所需的 CPU 时间片，通常表现为网络 Timeout、健康检查失败或服务不可用。

## 问题定位及解决思路

有时节点在低 cpu ‘us’ (user) 、高 cpu ‘id’ (idle) 的条件下，仍会出现负载很高的情况。通常是由于文件 IO 性能达到瓶颈，导致 IO Wait 过多，使节点整体负载升高，影响其它进程的性能。

1.  **查看平均负载及等待时间**
    

1.  登录节点，执行 `top` 命令查看当前负载。返回结果如下：
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/a2QnVZYyYZN7n4XB/img/f6740ef3-1c06-4f2e-8f85-4da2fee3056e.png)

可通过较高的 load average 值得知该节点正在承接大量的请求，也可以通过 Cpu(s)、Mem、%CPU 及 %MEM 列的数据获取哪些进程正在占用大多数资源。

2.  在返回结果界面，可查看核的 `wa` 值，`wa`（wait）表示 IO WAIT 的 CPU 占用。默认显示所有核的平均值，按**1**查看每个核的 `wa` 值。如下所示：
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/a2QnVZYyYZN7n4XB/img/808a88f7-6683-49bd-b69b-c90d5376d925.png)

wa 通常为0%，如果经常浮动在1%之上，说明存储设备的速度已经太慢，无法跟上 CPU 的处理速度。

**2. 监控磁盘IO统计信息**

1.  执行命令 `atop` ，查看当前磁盘 IO 状态。本例中，磁盘 `sda` 显示 `busy 100%` ，表示已达到严重性能瓶颈。
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/a2QnVZYyYZN7n4XB/img/64e5ec9f-8c47-46a1-9f12-97390f1263a8.png)

2.  查看占用磁盘 IO 的进程，有如下两种方法：
    

*   继续在该界面按 **d**，可查看哪些进程正在使用磁盘 IO。返回结果如下：
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/a2QnVZYyYZN7n4XB/img/610f4a95-9d88-4b32-8986-9002a33ad9d8.png)

*   也可以执行命令 `iotop -oPa` 查看哪些进程占用磁盘 IO。返回结果如下：
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/a2QnVZYyYZN7n4XB/img/7d8514da-ee7f-4d69-b1d1-5fb1b2a4bb2c.png)

# 四、微服务接口故障后如何检查和判断

1.  **确认故障范围：**
    

*   首先，确定故障是否影响整个微服务架构还是仅限于特定微服务。这可以通过监控面板、用户反馈、Nacos服务注册的状态来进行确定。
    

1.  **查看错误日志：**
    

*   检查受影响的微服务的日志文件，特别是错误日志。查看异常堆栈跟踪、错误消息以及可能的故障原因。这可以提供有关问题的线索。
    

1.  **检查依赖关系：**
    

*   如果微服务依赖于其他服务或组件（例如数据库、消息队列、外部API），请确保这些依赖项可用且正常工作。查看依赖项的状态和性能。
    

1.  **监控性能指标：**
    

*   使用监控工具来查看与受影响的微服务相关的性能指标。关注关键性能指标，例如响应时间、请求速率、CPU 和内存使用率等。比较当前数据与正常情况下的基准数据。
    

1.  **网络问题排查：**
    

*   检查网络连接和通信。确保网络配置正确，防火墙规则允许必要的流量，DNS 设置正确。使用 ping、traceroute 或网络抓包工具来测试网络通信。
    

1.  **资源问题排查：**
    

*   检查微服务使用的资源，包括 CPU 和内存。确保资源不会达到极限，导致性能下降或故障。
    
*   考虑是否需要水平扩展微服务以增加资源。
    

1.  **负载均衡问题排查：**
    

*   如果使用负载均衡器，确保它的配置正确，流量正常分发到可用的微服务实例。检查负载均衡器日志以查看请求的路由情况。
    

1.  **数据库问题排查：**
    

*   如果微服务依赖于数据库，检查数据库的性能和可用性。查看数据库日志和性能指标，包括查询性能和连接池使用情况。
    

1.  **代码问题排查：**
    

*   检查微服务代码，特别是涉及到故障的部分。查找代码错误、逻辑问题、未处理的异常或配置错误。修复代码问题。
    

1.   **版本问题排查：**
    

*   如果刚刚部署了新版本的微服务，考虑回滚到之前的稳定版本，以确定问题是否与新版本有关。
    

1.   **缓存问题排查：**
    

*   如果微服务使用缓存，请检查缓存的有效性和性能。清除缓存或刷新缓存内容，以确保数据一致性。
    

1.   **安全问题排查：**
    

*   检查安全措施，例如身份验证和授权机制。确保没有出现安全问题导致访问被拒绝或数据泄漏。
    

1.  **外部服务问题排查：**
    

*   如果微服务依赖于外部服务（例如第三方API或云服务），检查这些服务的可用性和性能。监控外部服务并查看其状态。
    

# 五、如何查询日志

1.  登录腾讯云控制台
    
2.  搜索日志服务
    
3.  进入检索分析，选择需要查看的日志集和主题
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/a2QnVZYyYZN7n4XB/img/1d0f8d9d-e98e-4ca9-8c9a-c8d91d7dcac5.png)

4.  添加检索条件过滤需要查看的服务日志，例如要查看搜索服务的日志
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/a2QnVZYyYZN7n4XB/img/eefc1596-a776-4e82-a72d-5f4a6328d2c4.png)

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/a2QnVZYyYZN7n4XB/img/265c17f9-4cc5-4920-984b-c1db0f9f4c93.png)

# 六、如何查看节点生存状态

1.  **腾讯云控制台查看**
    

进入集群：

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/a2QnVZYyYZN7n4XB/img/8d89bd24-e507-482c-88d8-cedccdbd5a7c.png)

进入节点管理中查看节点状态

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/a2QnVZYyYZN7n4XB/img/a1016874-b0c8-4e42-b8c6-7ddfaf96230c.png)

2.  **从Kuboard上查看节点状态**
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/a2QnVZYyYZN7n4XB/img/e8b894af-519f-418a-a5f8-1b53bdfff89f.png)

3.  **通过命令行查看**
    

使用 kubectl get nodes 命令检查节点的状态。

# 七、如何查看服务生存状态

1.  **查看Nacos上注册的服务、数量是否正常**
    

1.  进入腾讯云控制台
    
2.  进入腾讯云微服务引擎
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/a2QnVZYyYZN7n4XB/img/beac0775-5d77-4be8-9867-7470a12d53cf.png)

3.  进入nacos集群，通过公网地址访问nacos
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/a2QnVZYyYZN7n4XB/img/1cd638ae-0381-4b32-b100-ea89f761935d.png)

4.  切换到指定的命名空间下查看服务器状态
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/a2QnVZYyYZN7n4XB/img/00a25001-655c-4e21-945c-d73d35fc4221.png)

**2. 从Kuboard上查看服务Pod的正常运行情况**

如果没有出现红色的状态，基本上都是正常运行的状态

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/a2QnVZYyYZN7n4XB/img/e0d36ce0-4c2e-4987-8a27-4a416aad35ca.png)

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/a2QnVZYyYZN7n4XB/img/cedc4e66-45fb-40e6-ad27-41aaba7e54ff.png)

# 八、K8S内部网络故障

1.  **集群中不通节点上的容器(Pod)无法互访**
    

1.  检查上述不同节点间是否可以互访。
    
2.  检查节点安全组是否正确放通容器网段和对端节点所在的 VPC 网段或 VPC 子网网段。
    

**2. 同一个 VPC 内的节点与容器（Pod）无法互访**

1.  检查对端节点和 Pod 所在节点是否可以互访。
    
2.  Pod 所在节点的安全组是否正确放通对端节点所在的 VPC 子网网段。
    
3.  对端节点的安全组是否正确放通容器网段。
    

**3. 不同 VPC 内的节点与容器（Pod）或容器（Pod）与容器（Pod）间无法互访**

1.  检查节点与节点是否可以互访。
    
2.  检查对端节点的安全组是否正确放通 VPC 网段和容器网段。
    
3.  检查 Pod 所在节点的安全组是否正确放通对端节点所在的 VPC 网段或 VPC 子网网段。
    
4.  检查 Pod 所在节点的安全组是否正确放通对端 VPC 网段（或者节点所在的 VPC 子网网段）和容器网段。
    
5.  如需查看 Pod 的源 IP ，可执行以下命令，进一步修改 `ip\_masq\_agent` 的配置，彼此增加对方容器网段。
    
    1.  kubectl -n kube-system edit configmap ip-masq-agent-config
        

**4. 集群内 Service 无法访问**

Pod 之间一般是通过 Service 的 DNS 名称 my-svc.my-namespace.svc.cluster.local 来进行互访，如果在 Pod 内发生 Service 无法访问的情况，可通过如下检查：

1.  检查 Service 的 `spec.ports` 字段是否正确。
    
2.  测试 Service 的 ClusterIP 是否可通。若可通，则说明集群内 DNS 解析存在问题。
    
3.  测试 Service 的 Endpoint 是否可通。
    
4.  检查当前 Pod 所在节点上的 iptables 或者 ipvs 转发规则是否完整。
    

**5. 查看节点上的iptable和ipvs的转发规则**

1.  执行以下命令，检查 iptables 转发规则。
    
    1.  iptables-save
        
2.  执行以下命令，检查 ipvs 转发规则。
    
    1.  ipvsadm -Ln -t/-u ip:port
        

**6. 抓包命令**

1.  执行以下命令，在源 Pod 的节点上抓网卡 eth0 的包。
    
    1.  tcpdump -nn -vv -i eth0 host <对端pod-ip>
        
2.  执行以下命令，在对端 Pod 的节点上抓网卡 eth0 的包。
    
    1.  tcpdump -nn -vv -i eth0 host <源pod-ip>
        
3.  执行以下命令，在对端 Pod 的 netns 中抓网卡 eth0 的包。
    
    1.  tcpdump -nn -vv -i eth0 port <请求的端口号>
        

# 九、配置问题

1.  **Nacos**
    

1.  登入Nacos控制台
    
2.  进入所在命名空间
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/a2QnVZYyYZN7n4XB/img/821b1254-d677-4f9e-a988-27c93c8091ae.png)

3.  找到对应的微服务配置文件进行编辑
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/a2QnVZYyYZN7n4XB/img/2d1ff68b-cabb-440f-9ca6-04314b8b804b.png)

# 十、应用程序崩溃后如何重启

进入Kuboard重启对应的服务，例如重启搜索服务：

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/a2QnVZYyYZN7n4XB/img/92b6d1bc-0959-4619-b572-58ad061b28df.png)

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/a2QnVZYyYZN7n4XB/img/85a7ffb3-829e-420e-8e3f-7c7005b7971a.png)